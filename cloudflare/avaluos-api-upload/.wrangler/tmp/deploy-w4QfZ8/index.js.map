{
  "version": 3,
  "sources": ["../../../src/index.js"],
  "sourceRoot": "D:\\Desktop\\Dise\u00F1o\\Quetzal Habitats\\01_Marketing\\quetzal-avaluo\\cloudflare\\avaluos-api-upload\\.wrangler\\tmp\\deploy-w4QfZ8",
  "sourcesContent": ["/**\r\n * avaluos-api-upload\r\n * Cloudflare Worker para upload de archivos a Supabase Storage\r\n */\r\nconsole.log(\"Deploy test - \" + new Date().toISOString());\r\n\r\nexport default {\r\n    async fetch(request, env) {\r\n        // CORS headers\r\n        const corsHeaders = {\r\n            'Access-Control-Allow-Origin': '*',\r\n            'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n            'Access-Control-Allow-Headers': 'Content-Type',\r\n        };\r\n\r\n        // Handle OPTIONS preflight\r\n        if (request.method === 'OPTIONS') {\r\n            return new Response(null, { headers: corsHeaders });\r\n        }\r\n\r\n        if (request.method !== 'POST') {\r\n            return new Response(\r\n                JSON.stringify({ error: 'Method not allowed' }),\r\n                { status: 405, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n            );\r\n        }\r\n\r\n        try {\r\n            const supabaseUrl = env.SUPABASE_URL;\r\n            const supabaseKey = env.SUPABASE_SERVICE_ROLE_KEY || env.SUPABASE_ANON_KEY; // Fallback to Anon if Service Role is missing, but Service Role is needed for RLS bypass\r\n\r\n            if (!supabaseUrl || !supabaseKey) {\r\n                return new Response(\r\n                    JSON.stringify({ error: 'Supabase not configured' }),\r\n                    { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n                );\r\n            }\r\n\r\n            // Parse multipart form data\r\n            const formData = await request.formData();\r\n            const file = formData.get('file');\r\n\r\n            if (!file) {\r\n                return new Response(\r\n                    JSON.stringify({ error: 'No file uploaded' }),\r\n                    { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n                );\r\n            }\r\n\r\n            // Generate unique filename\r\n            const timestamp = Date.now();\r\n            const uniqueFileName = `${timestamp}-${file.name}`;\r\n\r\n            // Upload to Supabase Storage\r\n            const fileBuffer = await file.arrayBuffer();\r\n            const uploadResponse = await fetch(\r\n                `${supabaseUrl}/storage/v1/object/avaluo-documents/${uniqueFileName}`,\r\n                {\r\n                    method: 'POST',\r\n                    headers: {\r\n                        'apikey': supabaseKey,\r\n                        'Authorization': `Bearer ${supabaseKey}`,\r\n                        'Content-Type': file.type || 'application/octet-stream',\r\n                        'x-upsert': 'false'\r\n                    },\r\n                    body: fileBuffer\r\n                }\r\n            );\r\n\r\n            if (!uploadResponse.ok) {\r\n                const errorText = await uploadResponse.text();\r\n                console.error('Upload error details:', errorText);\r\n                return new Response(\r\n                    JSON.stringify({\r\n                        error: 'Failed to upload file',\r\n                        details: errorText,\r\n                        hint: 'Check if bucket \"avaluo-documents\" exists and is public'\r\n                    }),\r\n                    { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n                );\r\n            }\r\n\r\n            // Get public URL\r\n            const file_url = `${supabaseUrl}/storage/v1/object/public/avaluo-documents/${uniqueFileName}`;\r\n\r\n            return new Response(\r\n                JSON.stringify({\r\n                    file_url,\r\n                    fileName: uniqueFileName,\r\n                    originalName: file.name\r\n                }),\r\n                { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n            );\r\n\r\n        } catch (error) {\r\n            console.error('Function error:', error);\r\n            return new Response(\r\n                JSON.stringify({\r\n                    error: 'Internal server error',\r\n                    details: error.message\r\n                }),\r\n                { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n            );\r\n        }\r\n    }\r\n};\r\n"],
  "mappings": ";AAIA,QAAQ,IAAI,oBAAmB,oBAAI,KAAK,GAAE,YAAY,CAAC;AAEvD,IAAO,gBAAQ;AAAA,EACX,MAAM,MAAM,SAAS,KAAK;AAEtB,UAAM,cAAc;AAAA,MAChB,+BAA+B;AAAA,MAC/B,gCAAgC;AAAA,MAChC,gCAAgC;AAAA,IACpC;AAGA,QAAI,QAAQ,WAAW,WAAW;AAC9B,aAAO,IAAI,SAAS,MAAM,EAAE,SAAS,YAAY,CAAC;AAAA,IACtD;AAEA,QAAI,QAAQ,WAAW,QAAQ;AAC3B,aAAO,IAAI;AAAA,QACP,KAAK,UAAU,EAAE,OAAO,qBAAqB,CAAC;AAAA,QAC9C,EAAE,QAAQ,KAAK,SAAS,EAAE,GAAG,aAAa,gBAAgB,mBAAmB,EAAE;AAAA,MACnF;AAAA,IACJ;AAEA,QAAI;AACA,YAAM,cAAc,IAAI;AACxB,YAAM,cAAc,IAAI,6BAA6B,IAAI;AAEzD,UAAI,CAAC,eAAe,CAAC,aAAa;AAC9B,eAAO,IAAI;AAAA,UACP,KAAK,UAAU,EAAE,OAAO,0BAA0B,CAAC;AAAA,UACnD,EAAE,QAAQ,KAAK,SAAS,EAAE,GAAG,aAAa,gBAAgB,mBAAmB,EAAE;AAAA,QACnF;AAAA,MACJ;AAGA,YAAM,WAAW,MAAM,QAAQ,SAAS;AACxC,YAAM,OAAO,SAAS,IAAI,MAAM;AAEhC,UAAI,CAAC,MAAM;AACP,eAAO,IAAI;AAAA,UACP,KAAK,UAAU,EAAE,OAAO,mBAAmB,CAAC;AAAA,UAC5C,EAAE,QAAQ,KAAK,SAAS,EAAE,GAAG,aAAa,gBAAgB,mBAAmB,EAAE;AAAA,QACnF;AAAA,MACJ;AAGA,YAAM,YAAY,KAAK,IAAI;AAC3B,YAAM,iBAAiB,GAAG,SAAS,IAAI,KAAK,IAAI;AAGhD,YAAM,aAAa,MAAM,KAAK,YAAY;AAC1C,YAAM,iBAAiB,MAAM;AAAA,QACzB,GAAG,WAAW,uCAAuC,cAAc;AAAA,QACnE;AAAA,UACI,QAAQ;AAAA,UACR,SAAS;AAAA,YACL,UAAU;AAAA,YACV,iBAAiB,UAAU,WAAW;AAAA,YACtC,gBAAgB,KAAK,QAAQ;AAAA,YAC7B,YAAY;AAAA,UAChB;AAAA,UACA,MAAM;AAAA,QACV;AAAA,MACJ;AAEA,UAAI,CAAC,eAAe,IAAI;AACpB,cAAM,YAAY,MAAM,eAAe,KAAK;AAC5C,gBAAQ,MAAM,yBAAyB,SAAS;AAChD,eAAO,IAAI;AAAA,UACP,KAAK,UAAU;AAAA,YACX,OAAO;AAAA,YACP,SAAS;AAAA,YACT,MAAM;AAAA,UACV,CAAC;AAAA,UACD,EAAE,QAAQ,KAAK,SAAS,EAAE,GAAG,aAAa,gBAAgB,mBAAmB,EAAE;AAAA,QACnF;AAAA,MACJ;AAGA,YAAM,WAAW,GAAG,WAAW,8CAA8C,cAAc;AAE3F,aAAO,IAAI;AAAA,QACP,KAAK,UAAU;AAAA,UACX;AAAA,UACA,UAAU;AAAA,UACV,cAAc,KAAK;AAAA,QACvB,CAAC;AAAA,QACD,EAAE,QAAQ,KAAK,SAAS,EAAE,GAAG,aAAa,gBAAgB,mBAAmB,EAAE;AAAA,MACnF;AAAA,IAEJ,SAAS,OAAO;AACZ,cAAQ,MAAM,mBAAmB,KAAK;AACtC,aAAO,IAAI;AAAA,QACP,KAAK,UAAU;AAAA,UACX,OAAO;AAAA,UACP,SAAS,MAAM;AAAA,QACnB,CAAC;AAAA,QACD,EAAE,QAAQ,KAAK,SAAS,EAAE,GAAG,aAAa,gBAAgB,mBAAmB,EAAE;AAAA,MACnF;AAAA,IACJ;AAAA,EACJ;AACJ;",
  "names": []
}
