{
  "version": 3,
  "sources": ["../../../src/index.js"],
  "sourceRoot": "D:\\Desktop\\Dise\u00F1o\\Quetzal Habitats\\01_Marketing\\quetzal-avaluo\\cloudflare\\avaluos-api-analysis\\.wrangler\\tmp\\deploy-SlpP2e",
  "sourcesContent": ["/**\r\n * avaluos-api-analysis V10 (Robust + IQR + Deduplication + Normalization)\r\n * - Prompt V2 (Recomendado): L\u00F3gica de \u00E1rea din\u00E1mica + Fallback robusto\r\n * - Extracci\u00F3n estricta (V7 logic)\r\n * - Resumen conciso (V8 logic)\r\n * - Filtro IQR y Normalizaci\u00F3n (V10 logic)\r\n */\r\nconsole.log(\"Deploy V10 (Refined Logic) - \" + new Date().toISOString());\r\n\r\n// --- HELPER: Similitud de Texto (Levenshtein simplificado -> Ratio) ---\r\nfunction getSimilarity(s1, s2) {\r\n    if (!s1 || !s2) return 0;\r\n    const str1 = s1.toLowerCase().trim();\r\n    const str2 = s2.toLowerCase().trim();\r\n    if (str1 === str2) return 1;\r\n    if (str1.length === 0 || str2.length === 0) return 0;\r\n\r\n    const len1 = str1.length;\r\n    const len2 = str2.length;\r\n    const matrix = Array.from({ length: len1 + 1 }, () => Array(len2 + 1).fill(0));\r\n\r\n    for (let i = 0; i <= len1; i++) matrix[i][0] = i;\r\n    for (let j = 0; j <= len2; j++) matrix[0][j] = j;\r\n\r\n    for (let i = 1; i <= len1; i++) {\r\n        for (let j = 1; j <= len2; j++) {\r\n            const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;\r\n            matrix[i][j] = Math.min(\r\n                matrix[i - 1][j] + 1,\r\n                matrix[i][j - 1] + 1,\r\n                matrix[i - 1][j - 1] + cost\r\n            );\r\n        }\r\n    }\r\n    const distance = matrix[len1][len2];\r\n    return 1 - distance / Math.max(len1, len2);\r\n}\r\n\r\nexport default {\r\n    async fetch(request, env) {\r\n        // --- CORS ---\r\n        const corsHeaders = {\r\n            'Access-Control-Allow-Origin': '*',\r\n            'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n            'Access-Control-Allow-Headers': 'Content-Type',\r\n        };\r\n\r\n        if (request.method === 'OPTIONS') {\r\n            return new Response(null, { headers: corsHeaders });\r\n        }\r\n\r\n        if (request.method !== 'POST') {\r\n            return new Response(\r\n                JSON.stringify({ error: 'Method not allowed' }),\r\n                { status: 405, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n            );\r\n        }\r\n\r\n        // --- BODY ---\r\n        let body;\r\n        try {\r\n            body = await request.json();\r\n        } catch (e) {\r\n            return new Response(\r\n                JSON.stringify({ error: 'JSON inv\u00E1lido', details: e.message }),\r\n                { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n            );\r\n        }\r\n\r\n        const { formData } = body || {};\r\n        if (!formData) {\r\n            return new Response(\r\n                JSON.stringify({ error: 'formData es requerido' }),\r\n                { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n            );\r\n        }\r\n\r\n        const PERPLEXITY_API_KEY = env.PERPLEXITY_API_KEY;\r\n        const DEEPSEEK_API_KEY = env.DEEPSEEK_API_KEY;\r\n\r\n        if (!PERPLEXITY_API_KEY || !DEEPSEEK_API_KEY) {\r\n            return new Response(\r\n                JSON.stringify({ error: 'API keys no configuradas' }),\r\n                { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n            );\r\n        }\r\n\r\n        // --- 1. PREPARACI\u00D3N DE DATOS (V9 LOGIC) ---\r\n        const tipoInmueble = (formData.tipo_inmueble || 'inmueble').toLowerCase();\r\n        const esLote = tipoInmueble === 'lote';\r\n        const usoLote = formData.uso_lote || 'residencial'; // Default a residencial si no viene\r\n        const ubicacion = `${formData.barrio || ''}, ${formData.municipio || ''}`.trim();\r\n\r\n        // Fallback de \u00E1rea\r\n        let areaBase = parseInt(formData.area_construida);\r\n        if (!Number.isFinite(areaBase) || areaBase <= 0) areaBase = 60;\r\n        const area = areaBase;\r\n\r\n        // --- VARIABLES V9 ---\r\n        const areaConstruida = area;\r\n        const infoInmueble = `\r\n- Tipo: ${tipoInmueble}\r\n${esLote ? `- Uso del Lote: ${usoLote}` : ''}\r\n- Ubicaci\u00F3n: ${ubicacion}\r\n${formData.nombre_conjunto ? `- Conjunto/Edificio: ${formData.nombre_conjunto}` : ''}\r\n${!esLote ? `- Habitaciones: ${formData.habitaciones || '?'}` : ''}\r\n${!esLote ? `- Ba\u00F1os: ${formData.banos || '?'}` : ''}\r\n${!esLote ? `- Parqueadero: ${formData.tipo_parqueadero || 'No indicado'}` : ''}\r\n${!esLote ? `- Antig\u00FCedad: ${formData.antiguedad || 'No indicada'}` : ''}\r\n${!esLote ? `- Estado: ${formData.estado_inmueble || 'No especificado'}` : ''}\r\n${!esLote && formData.tipo_remodelacion ? `- Remodelaci\u00F3n: ${formData.tipo_remodelacion} (${formData.valor_remodelacion || 'Valor no indicado'})` : ''}\r\n${!esLote && formData.descripcion_mejoras ? `- Mejoras: ${formData.descripcion_mejoras}` : ''}\r\n${formData.informacion_complementaria ? `- NOTAS ADICIONALES: ${formData.informacion_complementaria}` : ''}\r\n`.trim();\r\n\r\n        const areaInstruction = areaConstruida\r\n            ? `\r\n- \u00C1REA CONSTRUIDA: ${areaConstruida} m\u00B2\r\n- Rango de \u00E1reas VENTA (Estricto): ${Math.round(area * 0.5)} a ${Math.round(area * 1.5)} m\u00B2 (\u00B150%)\r\n- SOLO incluye comparables de venta cuyas \u00E1reas est\u00E9n dentro de este rango. Para arriendos, intenta mantener el \u00E1rea similar, pero prioriza encontrar datos.`\r\n            : '';\r\n\r\n        // --- INSTRUCCIONES ESPEC\u00CDFICAS PARA LOTES ---\r\n        const instruccionesLote = esLote ? `\r\nINSTRUCCIONES ESPECIALES PARA LOTES:\r\n1. OMITIR POR COMPLETO EL ENFOQUE DE RENTABILIDAD.\r\n   - PROHIBIDO BUSCAR O INCLUIR ARRIENDOS. SOLO VENTA.\r\n2. Busca SOLO comparables de VENTA de lotes con uso ${usoLote}.\r\n3. Si no encuentras suficientes lotes comparables en venta en la zona:\r\n   - Puedes considerar inmuebles ${usoLote === 'comercial' ? 'comerciales' : 'residenciales'} construidos en el mismo sector.\r\n   - Estima el valor aproximado del terreno como un porcentaje razonable del valor total del inmueble (M\u00E9todo Residual).\r\n   - Por ejemplo, un lote puede valer entre 25% y 40% del valor de una propiedad construida si el terreno es el activo principal.\r\n   - Explica claramente si usas esta l\u00F3gica de \"proxy\" en el an\u00E1lisis.\r\n4. Evita comparar con fincas productivas o proyectos de gran escala si el lote es peque\u00F1o/urbano.\r\n5. METODOLOG\u00CDA:\r\n   - NUNCA uses la frase \"Punto de equilibrio\" ni \"Enfoque de ingresos\".\r\n   - USA EXACTAMENTE ESTA FRASE en tu resumen: \"Valor obtenido a partir del an\u00E1lisis de mercado y m\u00E9todo residual, sin aplicar enfoque de rentabilidad\".\r\n` : '';\r\n\r\n        // --- PROMPT V9 (ROBUSTO + FALLBACK) ---\r\n        const perplexityPrompt = `\r\nEres un analista inmobiliario especializado en aval\u00FAos comerciales t\u00E9cnicos y estimaci\u00F3n de valor apoyada en datos estad\u00EDsticos del mercado colombiano.\r\nTu tarea es elaborar un **an\u00E1lisis completo, claro y profesional**, incluso cuando la informaci\u00F3n disponible sea limitada.\r\n\r\nDATOS DEL INMUEBLE\r\n-------------------\r\nBasado en estos datos proporcionados por el usuario:\r\n${infoInmueble}\r\n${areaInstruction}\r\n\r\n${instruccionesLote}\r\n\r\nINSTRUCCIONES GENERALES (GESTI\u00D3N DE FALLBACK)\r\n---------------------------------------------\r\n1. Si no encuentras suficientes datos reales en portales inmobiliarios, DEBES complementar con:\r\n   - Estad\u00EDsticas municipales y regionales.\r\n   - Valores t\u00EDpicos de mercado seg\u00FAn tama\u00F1o del inmueble y ubicaci\u00F3n.\r\n2. NUNCA devuelvas valores \"0\", \"null\", \"N/A\" o similares.\r\n3. Si un dato no aparece directamente, GENERA una estimaci\u00F3n razonable basada en promedios municipales.\r\n4. Siempre entrega comparables suficientes:\r\n   - Entrega idealmente entre 15 y 20 comparables en total.\r\n   - ${esLote ? 'SOLO incluye propiedades en VENTA (Estrictamente prohibido arriendos).' : 'Incluye AL MENOS 6 propiedades en ARRIENDO en barrios similares para enriquecer el an\u00E1lisis.'}\r\n   - Incluye propiedades de barrios similares.\r\n5. NO incluyas hiperv\u00EDnculos ni enlaces. Solo textos descriptivos.\r\n6. Incluye precios, \u00E1reas y valores de mercado siempre en pesos colombianos.\r\n7. Responde SIEMPRE en espa\u00F1ol.\r\n8. IMPORTANTE: Todas las cifras deben escribirse COMPLETAS en pesos colombianos, sin abreviaciones.\r\n   Ejemplo: usar $4.200.000, NO 4.2M ni 4.200K.\r\n9. VALIDACI\u00D3N DE URLS:\r\n   - Para cada comparable, incluye el campo \"url: ...\" y \"url_estado: ...\".\r\n   - Si la URL es real y verificable, url_estado = \"real\".\r\n   - Si no puedes verificarla o es inferida, url_estado = \"estimado\" y url = null.\r\n   - NUNCA inventes URLs.\r\n10. Sincronizaci\u00F3n de Conteos:\r\n    - Ajusta el campo \"total_comparables\" mencionado en el texto para que COINCIDA EXACTAMENTE con el n\u00FAmero de items listados.\r\n\r\nTAREAS\r\n------\r\n\r\n## 1. B\u00DASQUEDA Y SELECCI\u00D3N DE COMPARABLES\r\n\r\nPrimero, detalla brevemente la disponibilidad de informaci\u00F3n encontrada.\r\n\r\nLuego presenta un listado de **entre 15 a 20 comparables** usando EXACTAMENTE este formato (usa la etiqueta <br> para saltos de l\u00EDnea):\r\n\r\n**[T\u00EDtulo descriptivo del inmueble]**<br>\r\n[Tipo de inmueble] | [Venta/Arriendo]<br>\r\n$[Precio] | [\u00C1rea] m\u00B2 | [Hab] hab | [Ba\u00F1os] ba\u00F1os<br>\r\n[Barrio] | [Ciudad]<br>\r\n**[Fuente]**<br>\r\nurl: [Enlace directo o null]<br>\r\nurl_estado: [real/estimado]\r\n\r\nEjemplo:\r\n**Apartamento en Condina, Pereira**<br>\r\nApartamento | Venta<br>\r\n$245.000.000 | 68 m\u00B2 | 3 hab | 2 ba\u00F1os<br>\r\nCondina | Pereira<br>\r\n**Fincaraiz**<br>\r\nurl: https://fincaraiz.com.co/ejemplo<br>\r\nurl_estado: real\r\n\r\nIMPORTANTE: \r\n- Respeta EXACTAMENTE este formato.\r\n- Usa la etiqueta HTML \\`<br>\\` al final de cada l\u00EDnea para garantizar el salto de l\u00EDnea visual.\r\n- Separa cada comparable con una l\u00EDnea en blanco adicional.\r\n\r\n## 2. AN\u00C1LISIS DEL VALOR\r\n\r\n### 2.1. M\u00E9todo de Venta Directa (Precio por m\u00B2)\r\n- Calcula el valor promedio por m\u00B2 del mercado bas\u00E1ndote en los comparables de venta filtrados.\r\n- Indica el valor por m\u00B2 FINAL que decides usar (ajustado por antig\u00FCedad, estado, etc.).\r\n- Calcula el valor estimado: Precio por m\u00B2 final \u00D7 ${areaConstruida || '\u00E1rea'} m\u00B2.\r\n\r\n${!esLote ? `### 2.2. M\u00E9todo de Rentabilidad (Yield Mensual)\r\n- **C\u00C1LCULO DEL CANON:** No uses un promedio simple de precios totales.\r\n  1. Calcula el precio por m\u00B2 de arriendo de cada comparable (Precio / \u00C1rea).\r\n  2. Obt\u00E9n el promedio de canon/m\u00B2.\r\n  3. Multiplica ese promedio por los ${areaConstruida || 'metros'} m\u00B2 del inmueble objetivo para obtener el Canon Mensual Estimado.\r\n- Investiga y Estima el Yield mensual promedio del sector (ej: 0.4% - 0.6%).\r\n- Presenta el Yield mensual promedio del sector **Yield promedio mercado: 0.45%**\r\n- Aplica la f\u00F3rmula: Valor estimado = Canon Mensual Estimado / Yield mensual promedio.` : ''}\r\n\r\n## 3. RESULTADOS FINALES\r\nEntrega de forma clara:\r\n- **Valor Recomendado de Venta: $XXX.XXX.XXX** (valor \u00FAnico, ajustado por todos los factores)\r\n- **Rango sugerido: $XXX.XXX.XXX - $XXX.XXX.XXX** (rango de publicaci\u00F3n recomendado)\r\n- Precio por m\u00B2 final usado para el c\u00E1lculo.\r\n- Comentario sobre la posici\u00F3n del inmueble en el mercado (liquidez).\r\n\r\n## 4. AJUSTES APLICADOS\r\nExplica ajustes aplicados por antig\u00FCedad, estado, parqueadero, caracter\u00EDsticas especiales, etc.\r\n\r\n## 5. LIMITACIONES\r\nMenciona escasez de datos, dependencias de promedios regionales, o cualquier limitaci\u00F3n del an\u00E1lisis.\r\n\r\n## 6. RESUMEN EJECUTIVO\r\nCierra con 2-3 p\u00E1rrafos claros que incluyan:\r\n1. Valor t\u00E9cnico recomendado\r\n2. Rango de publicaci\u00F3n sugerido\r\n3. Estrategia de venta y posicionamiento de mercado\r\n\r\nFORMATO FINAL\r\n--------\r\n- La secci\u00F3n 1 DEBE usar el formato de lista especificado (NO tabla markdown).\r\n- Las dem\u00E1s secciones deben ser texto narrativo claro.\r\n- NO devuelvas JSON.\r\n        `.trim();\r\n\r\n        // --- 2. LLAMADA A PERPLEXITY (MODELO SONAR) ---\r\n        let perplexityContent = '';\r\n        let citations = [];\r\n\r\n        try {\r\n            const response = await fetch('https://api.perplexity.ai/chat/completions', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    Authorization: `Bearer ${PERPLEXITY_API_KEY}`,\r\n                },\r\n                body: JSON.stringify({\r\n                    model: 'sonar',\r\n                    messages: [\r\n                        { role: 'system', content: 'Eres un analista inmobiliario preciso y profesional.' },\r\n                        { role: 'user', content: perplexityPrompt },\r\n                    ],\r\n                    temperature: 0.1,\r\n                }),\r\n            });\r\n\r\n            if (!response.ok) {\r\n                const errText = await response.text();\r\n                return new Response(\r\n                    JSON.stringify({ error: `Error Perplexity (${response.status})`, details: errText }),\r\n                    { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n                );\r\n            }\r\n\r\n            const data = await response.json();\r\n            perplexityContent = data.choices?.[0]?.message?.content || '';\r\n            citations = data.citations || [];\r\n            console.log(`Perplexity completado. Fuentes: ${citations.length}`);\r\n\r\n        } catch (e) {\r\n            return new Response(\r\n                JSON.stringify({ error: 'Error conexi\u00F3n Perplexity', details: e.message }),\r\n                { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n            );\r\n        }\r\n\r\n        // --- 3. EXTRACCI\u00D3N ESTRUCTURADA CON DEEPSEEK ---\r\n        const extractionPrompt = `\r\nDel siguiente texto (que contiene listados y an\u00E1lisis), extrae un JSON estructurado.\r\n\r\nTEXTO:\r\n${perplexityContent}\r\n\r\nINSTRUCCIONES DE EXTRACCI\u00D3N:\r\n1. \"comparables\": Extrae CADA INMUEBLE del listado (formato multi-l\u00EDnea, NO tabla).\r\n   Cada comparable sigue este patr\u00F3n:\r\n   \r\n   **T\u00EDtulo**\r\n   Tipo | Venta/Arriendo\r\n   Precio | \u00C1rea | Habitaciones | Ba\u00F1os\r\n   Barrio | Ciudad\r\n   **Fuente**\r\n   \r\n   Extrae:\r\n   - \"titulo\": Texto entre ** ** de la primera l\u00EDnea (sin etiquetas HTML)\r\n   - \"tipo_inmueble\": Texto antes del | en la segunda l\u00EDnea (sin etiquetas HTML)\r\n   - \"tipo_operacion\": Texto despu\u00E9s del | en la segunda l\u00EDnea (\"Venta\" o \"Arriendo\")\r\n   - \"precio_lista\": N\u00FAmero ENTERO (sin puntos, sin comas, sin $) extra\u00EDdo de la tercera l\u00EDnea.\r\n   - \"area\": N\u00FAmero (puede tener decimales) antes de \"m\u00B2\" en la tercera l\u00EDnea.\r\n   - \"habitaciones\": N\u00FAmero antes de \"hab\" en la tercera l\u00EDnea\r\n   - \"banos\": N\u00FAmero antes de \"ba\u00F1os\" en la tercera l\u00EDnea\r\n   - \"barrio\": Texto antes del | en la cuarta l\u00EDnea (sin etiquetas HTML)\r\n   - \"ciudad\": Texto despu\u00E9s del | en la cuarta l\u00EDnea (sin etiquetas HTML)\r\n   - \"fuente\": Texto entre ** ** (usualmente antepen\u00FAltima l\u00EDnea)\r\n   - \"url\": Texto despu\u00E9s de \"url: \" (pen\u00FAltima l\u00EDnea, o null si no existe)\r\n   - \"url_estado\": Texto despu\u00E9s de \"url_estado: \" (\u00FAltima l\u00EDnea)\r\n\r\n   IMPORTANTE: Elimina cualquier etiqueta HTML (como <br>) de los valores extra\u00EDdos.\r\n\r\n2. \"resumen_mercado\": Extrae un resumen conciso (m\u00E1ximo 2 p\u00E1rrafos) de la secci\u00F3n \"RESUMEN EJECUTIVO\". Prioriza la valoraci\u00F3n y la rentabilidad.\r\n\r\n3. \"yield_zona\": ${esLote ? 'IGNORAR (Devolver null)' : 'Busca la frase exacta \"Yield promedio mercado: X.XX%\" en el texto. Extrae SOLO el n\u00FAmero como decimal (ej: si dice \"0.45%\", devuelve 0.0045).'}\r\n\r\n4. \"valor_recomendado_venta\": Busca \"Valor Recomendado de Venta: $XXX.XXX.XXX\".\r\n   Extrae el n\u00FAmero ENTERO (elimina puntos y $).\r\n\r\n5. \"rango_sugerido_min\": Busca \"Rango sugerido: $XXX.XXX.XXX - $YYY.YYY.YYY\". Extrae el primer n\u00FAmero (ENTERO).\r\n\r\n6. \"rango_sugerido_max\": Extrae el segundo n\u00FAmero del rango sugerido (ENTERO).\r\n\r\nDevuelve SOLO JSON v\u00E1lido.\r\n        `.trim();\r\n\r\n        let extractedData = {};\r\n        try {\r\n            const dsResponse = await fetch('https://api.deepseek.com/v1/chat/completions', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    Authorization: `Bearer ${DEEPSEEK_API_KEY}`,\r\n                },\r\n                body: JSON.stringify({\r\n                    model: 'deepseek-chat',\r\n                    messages: [\r\n                        { role: 'system', content: 'Eres un extractor JSON experto. Extrae numeros LIMPIOS (ej: 4200000, no 4.200.000).' },\r\n                        { role: 'user', content: extractionPrompt },\r\n                    ],\r\n                    temperature: 0.0,\r\n                }),\r\n            });\r\n\r\n            if (!dsResponse.ok) {\r\n                const errDs = await dsResponse.text();\r\n                return new Response(\r\n                    JSON.stringify({ error: `Error DeepSeek (${dsResponse.status})`, details: errDs }),\r\n                    { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n                );\r\n            }\r\n\r\n            const dsData = await dsResponse.json();\r\n            let content = dsData.choices?.[0]?.message?.content || '{}';\r\n\r\n            // Limpieza Markdown\r\n            content = content.trim();\r\n            if (content.startsWith('```')) {\r\n                const match = content.match(/```(?:json)?\\s*([\\s\\S]*?)```/i);\r\n                if (match && match[1]) content = match[1].trim();\r\n            }\r\n\r\n            extractedData = JSON.parse(content);\r\n\r\n        } catch (e) {\r\n            return new Response(\r\n                JSON.stringify({ error: 'Error Parseo DeepSeek', details: e.message }),\r\n                { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n            );\r\n        }\r\n\r\n        // --- 4. PROCESAMIENTO Y L\u00D3GICA DE NEGOCIO ---\r\n        // Helpers robustos para parseo\r\n        const sanitizePrice = (n) => {\r\n            if (typeof n === 'number') return Number.isFinite(n) ? n : null;\r\n            if (typeof n === 'string') {\r\n                const clean = n.replace(/\\D/g, '');\r\n                const val = parseInt(clean, 10);\r\n                return (Number.isFinite(val) && val > 0) ? val : null;\r\n            }\r\n            return null;\r\n        };\r\n\r\n        const sanitizeFloat = (n) => {\r\n            if (typeof n === 'number') return Number.isFinite(n) ? n : null;\r\n            if (typeof n === 'string') {\r\n                const clean = n.replace(',', '.').replace(/[^\\d.]/g, '');\r\n                const val = parseFloat(clean);\r\n                return Number.isFinite(val) ? val : null;\r\n            }\r\n            return null;\r\n        };\r\n\r\n        const yieldDefault = 0.005;  // 0.5% mensual (6% anual) - solo fallback\r\n        const yieldExtracted = sanitizeFloat(extractedData.yield_zona);\r\n        const yieldFinal = yieldExtracted || yieldDefault;\r\n        console.log(`Yield usado: ${(yieldFinal * 100).toFixed(2)}% mensual (${yieldExtracted ? 'extra\u00EDdo de mercado' : 'fallback'})`);\r\n        const yieldFuente = yieldExtracted ? 'mercado' : 'fallback';\r\n\r\n        // Portales\r\n        const portalesUnicos = new Set(\r\n            citations.map((url) => {\r\n                try {\r\n                    return new URL(url).hostname.replace('www.', '').replace('.com.co', '').replace('.com', '');\r\n                } catch { return null; }\r\n            }).filter(Boolean)\r\n        );\r\n        const portalesList = Array.from(portalesUnicos);\r\n        if (portalesList.length === 0) portalesList.push('fincaraiz', 'metrocuadrado');\r\n\r\n        // Procesamiento de Comparables (SIN HEUR\u00CDSTICA)\r\n        const comparables = (extractedData.comparables || [])\r\n            .map((c) => {\r\n                const areaComp = sanitizeFloat(c.area);\r\n                const precioLista = sanitizePrice(c.precio_lista);\r\n\r\n                const esArriendo = c.tipo_operacion?.toLowerCase().includes('arriendo');\r\n\r\n                // SI ES LOTE, IGNORAR ARRIENDOS\r\n                if (esLote && esArriendo) return null;\r\n\r\n                let precioVentaEstimado = 0;\r\n                let precioM2 = 0;\r\n\r\n                if (esArriendo) {\r\n                    // Arriendo -> Capitalizaci\u00F3n\r\n                    if (precioLista && yieldFinal > 0) {\r\n                        precioVentaEstimado = Math.round(precioLista / yieldFinal);\r\n                    }\r\n                    if (precioVentaEstimado && areaComp) {\r\n                        precioM2 = Math.round(precioVentaEstimado / areaComp);\r\n                    }\r\n                } else {\r\n                    // Venta -> Directo\r\n                    precioVentaEstimado = precioLista || 0;\r\n                    if (precioVentaEstimado && areaComp) {\r\n                        precioM2 = Math.round(precioVentaEstimado / areaComp);\r\n                    }\r\n                }\r\n\r\n                return {\r\n                    titulo: c.titulo || 'Inmueble',\r\n                    tipo_origen: esArriendo ? 'arriendo' : 'venta',\r\n                    tipo_inmueble: c.tipo_inmueble || tipoInmueble,\r\n                    barrio: c.barrio || c.ubicacion || formData.barrio,\r\n                    municipio: c.ciudad || formData.municipio,\r\n                    area_m2: areaComp,\r\n                    habitaciones: sanitizeFloat(c.habitaciones),\r\n                    banos: sanitizeFloat(c.banos),\r\n\r\n                    precio_publicado: precioLista,\r\n                    precio_cop: precioVentaEstimado,\r\n                    precio_m2: precioM2,\r\n                    yield_mensual: esArriendo ? yieldFinal : null,\r\n\r\n                    url: c.url,\r\n                    url_estado: c.url_estado\r\n                };\r\n            })\r\n            .filter((c) => c && c.precio_cop > 0 && c.area_m2 > 0);\r\n\r\n        // Validaci\u00F3n M\u00EDnima\r\n        if (comparables.length < 5) {\r\n            return new Response(\r\n                JSON.stringify({\r\n                    error: 'Datos insuficientes',\r\n                    details: `Solo se encontraron ${comparables.length} comparables v\u00E1lidos.`,\r\n                    perplexity_full_text: perplexityContent,\r\n                }),\r\n                { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n            );\r\n        }\r\n\r\n        // C\u00E1lculos Finales\r\n        const compsVenta = comparables.filter((c) => c.tipo_origen === 'venta');\r\n        const compsArriendo = comparables.filter((c) => c.tipo_origen === 'arriendo');\r\n\r\n        // 1. Venta Directa (CON PODA DE OUTLIERS)\r\n        let valorVentaDirecta = null;\r\n        let precioM2Promedio = 0;\r\n\r\n        if (compsVenta.length > 0) {\r\n            const sortedByM2 = [...compsVenta].sort((a, b) => a.precio_m2 - b.precio_m2);\r\n            // Poda del 10%\r\n            let filteredComps = sortedByM2;\r\n            if (sortedByM2.length >= 5) {\r\n                const cut = Math.floor(sortedByM2.length * 0.1);\r\n                filteredComps = sortedByM2.slice(cut, sortedByM2.length - cut);\r\n            }\r\n\r\n            const sumM2 = filteredComps.reduce((acc, c) => acc + c.precio_m2, 0);\r\n            precioM2Promedio = Math.round(sumM2 / filteredComps.length);\r\n            valorVentaDirecta = Math.round(precioM2Promedio * area);\r\n        }\r\n\r\n        // 2. Rentabilidad\r\n        let valorRentabilidad = null;\r\n        let canonPromedio = 0;\r\n\r\n        if (!esLote) {\r\n            if (compsArriendo.length > 0) {\r\n                const sumCanon = compsArriendo.reduce((acc, c) => acc + c.precio_publicado, 0);\r\n                canonPromedio = Math.round(sumCanon / compsArriendo.length);\r\n                valorRentabilidad = Math.round(canonPromedio / yieldFinal);\r\n            } else {\r\n                if (valorVentaDirecta) {\r\n                    valorRentabilidad = valorVentaDirecta;\r\n                    canonPromedio = Math.round(valorVentaDirecta * yieldFinal);\r\n                }\r\n            }\r\n        }\r\n\r\n        // 3. Valor Recomendado Perplexity\r\n        const valorRecomendado = sanitizePrice(extractedData.valor_recomendado_venta);\r\n\r\n        let valorPonderado = null;\r\n        if (esLote) {\r\n            valorPonderado = valorVentaDirecta;\r\n        } else {\r\n            valorPonderado = (valorVentaDirecta && valorRentabilidad && compsArriendo.length > 0)\r\n                ? Math.round(valorVentaDirecta * 0.6 + valorRentabilidad * 0.4)\r\n                : null;\r\n        }\r\n\r\n        const valorFinal = valorRecomendado || valorVentaDirecta || valorRentabilidad || 0;\r\n        const valorFuente = valorRecomendado ? 'perplexity' : 'calculado';\r\n\r\n        // Correcci\u00F3n Lotes\r\n        if (esLote && valorRecomendado) {\r\n            valorVentaDirecta = valorRecomendado;\r\n            precioM2Promedio = Math.round(valorRecomendado / area);\r\n        }\r\n\r\n        console.log(`Valor final: $${valorFinal.toLocaleString()} (fuente: ${valorFuente})`);\r\n\r\n        const precioM2Usado = precioM2Promedio || (valorFinal > 0 ? Math.round(valorFinal / area) : 0);\r\n\r\n        // 4. Rangos\r\n        const rangoMin = sanitizePrice(extractedData.rango_sugerido_min) || Math.round(valorFinal * 1.00);\r\n        const rangoMax = sanitizePrice(extractedData.rango_sugerido_max) || Math.round(valorFinal * 1.04);\r\n        const rangoFuente = extractedData.rango_sugerido_min ? 'perplexity' : 'calculado';\r\n\r\n        // --- 5. DEDUPLICACI\u00D3N Y FILTRADO (V10) ---\r\n        const uniqueComparables = [];\r\n        for (const comp of comparables) {\r\n            const isDuplicate = uniqueComparables.some(existing => {\r\n                const precioBaseExisting = existing.precio_cop || existing.precio_publicado || 0;\r\n                const precioBaseComp = comp.precio_cop || comp.precio_publicado || 0;\r\n                const areaBaseExisting = existing.area_m2 || 0;\r\n                const areaBaseComp = comp.area_m2 || 0;\r\n\r\n                const priceMatch = precioBaseExisting > 0\r\n                    ? Math.abs(precioBaseExisting - precioBaseComp) / precioBaseExisting < 0.01\r\n                    : false;\r\n                const areaMatch = areaBaseExisting > 0\r\n                    ? Math.abs(areaBaseExisting - areaBaseComp) / areaBaseExisting < 0.01\r\n                    : false;\r\n                const titleSim = getSimilarity(existing.titulo, comp.titulo);\r\n\r\n                return priceMatch && areaMatch && titleSim >= 0.7;\r\n            });\r\n            if (!isDuplicate) uniqueComparables.push(comp);\r\n        }\r\n\r\n        // Filtro Area\r\n        let comparablesFiltradosPorArea = uniqueComparables;\r\n        if (!esLote || area <= 1000) {\r\n            comparablesFiltradosPorArea = uniqueComparables.filter(c => {\r\n                const a = c.area_m2 || 0;\r\n                return a >= area * 0.5 && a <= area * 1.5;\r\n            });\r\n        }\r\n\r\n        // Filtro Lote Grande\r\n        let comparablesParaTabla = comparablesFiltradosPorArea;\r\n        if (esLote && area > 1000) {\r\n            const filtrados = comparablesFiltradosPorArea.filter(c => (c.area_m2 || 0) >= 500);\r\n            comparablesParaTabla = filtrados.length >= 3 ? filtrados : comparablesFiltradosPorArea;\r\n        }\r\n\r\n        // D) FILTRO IQR (New V10 Logic)\r\n        if (comparablesParaTabla.length >= 5) {\r\n            const preciosM2 = comparablesParaTabla.map(c => c.precio_m2).filter(p => p > 0).sort((a, b) => a - b);\r\n            if (preciosM2.length >= 4) {\r\n                const q1Index = Math.floor(preciosM2.length * 0.25);\r\n                const q3Index = Math.floor(preciosM2.length * 0.75);\r\n                const q1 = preciosM2[q1Index];\r\n                const q3 = preciosM2[q3Index];\r\n                const iqr = q3 - q1;\r\n                const minThreshold = q1 - iqr * 1.5;\r\n                const maxThreshold = q3 + iqr * 1.5;\r\n\r\n                const filtradosIQR = comparablesParaTabla.filter(c =>\r\n                    c.precio_m2 >= minThreshold && c.precio_m2 <= maxThreshold\r\n                );\r\n\r\n                if (filtradosIQR.length >= 5) {\r\n                    console.log(`Filtro IQR aplicado.`);\r\n                    comparablesParaTabla = filtradosIQR;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Normalizaci\u00F3n Nombres\r\n        comparablesParaTabla = comparablesParaTabla.map(c => {\r\n            let fuente = c.fuente || 'Portal Inmobiliario';\r\n            if (typeof fuente === 'string') {\r\n                fuente = fuente.replace(/Clencuadras/i, 'Ciencuadras')\r\n                    .replace(/Fincaraiz/i, 'FincaRa\u00EDz')\r\n                    .replace(/MetroCuadrado/i, 'Metrocuadrado')\r\n                    .replace(/Mercadolibre/i, 'MercadoLibre');\r\n            }\r\n            return { ...c, fuente };\r\n        });\r\n\r\n        // Sincronizaci\u00F3n de Conteos\r\n        const totalReal = comparablesParaTabla.length;\r\n        let finalPerplexityText = perplexityContent || '';\r\n        finalPerplexityText = finalPerplexityText.replace(/(presentan|listado de|encontraron|selecci\u00F3n de)\\s+(\\d+)\\s+(comparables|inmuebles|propiedades)/gi, `$1 ${totalReal} $3`);\r\n\r\n        let resumenFinal = extractedData.resumen_mercado || 'An\u00E1lisis de mercado realizado.';\r\n        resumenFinal = resumenFinal.replace(/(presentan|listado de|encontraron|selecci\u00F3n de)\\s+(\\d+)\\s+(comparables|inmuebles|propiedades)/gi, `$1 ${totalReal} $3`);\r\n\r\n        const resultado = {\r\n            resumen_busqueda: resumenFinal,\r\n            valor_final: valorFinal,\r\n            valor_fuente: valorFuente,\r\n            valor_ponderado_referencia: valorPonderado,\r\n            rango_valor_min: rangoMin,\r\n            rango_valor_max: rangoMax,\r\n            rango_fuente: rangoFuente,\r\n\r\n            valor_estimado_venta_directa: valorVentaDirecta,\r\n            valor_estimado_rentabilidad: valorRentabilidad,\r\n\r\n            // ERROR 2\r\n            precio_m2_final: precioM2Usado,\r\n\r\n            // ERROR 3\r\n            metodo_mercado_label: 'Enfoque de Mercado (promedio real)',\r\n            metodo_ajuste_label: valorRecomendado ? 'Ajuste de Perplexity (criterio t\u00E9cnico)' : 'Promedio de Mercado',\r\n\r\n            comparables: comparablesParaTabla,\r\n            total_comparables: comparablesParaTabla.length,\r\n\r\n            // ERROR 1: Defaults\r\n            ficha_tecnica_defaults: {\r\n                habitaciones: 'No especificado',\r\n                banos: 'No especificado',\r\n                garajes: 'No especificado',\r\n                estrato: 'No especificado',\r\n                antiguedad: 'No especificado'\r\n            },\r\n\r\n            yield_mensual_mercado: yieldFinal,\r\n            area_construida: area,\r\n            perplexity_full_text: finalPerplexityText\r\n        };\r\n\r\n        return new Response(JSON.stringify(resultado), {\r\n            headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        });\r\n    },\r\n};"],
  "mappings": "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",
  "names": []
}
